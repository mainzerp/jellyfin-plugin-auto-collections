<!doctype html>
<html>
  <head>
    <title>Auto Collections</title>
    <style>      
    .title-match-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .match-type-container {
        width: 100px;
        margin-right: 10px;
      }
      .match-type-select {
        width: 100%;
      }
      .title-match-input {
        flex: 1;
        margin-right: 10px;
      }
      .collection-name-input {
        flex: 1;
        margin-right: 10px;
      }
      .case-sensitive-check {
        margin-right: 10px;
        display: flex;
        align-items: center;
      }
      .case-label {
        white-space: nowrap;
        margin-right: 5px;
      }
      .add-title-match-button {
        margin-bottom: 15px;
      }
      .remove-button {
        margin-left: 10px;
        min-width: 40px;
      }
      #title-match-pairs {
        margin-bottom: 20px;
      }      .help-text {
        font-size: 0.9em;
        color: #888;
        margin-top: 5px;
        margin-bottom: 15px;
      }
      .expression-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      code {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
      }
      .section-divider {
        margin-top: 30px;
        margin-bottom: 20px;
        border-top: 1px solid rgba(128, 128, 128, 0.2);
      }
    </style>
  </head>

  <body>
    <div
      data-role="page"
      class="page type-interior pluginConfigurationPage tbsConfigurationPage"
      data-require="emby-input,emby-button,emby-select,emby-checkbox"
    >
      <div data-role="content">
        <div class="content-primary">
          <form class="tbsConfigurationPage">
            <div class="sectionTitleContainer flex align-items-center">
              <h2 class="sectionTitle">Auto Collections</h2>
              <a
                is="emby-linkbutton"
                class="raised button-alt headerHelpButton emby-button"
                target="_blank"
                href="https://github.com/KeksBombe/jellyfin-plugin-auto-collections/blob/main/README.md"
              >Help</a>
            </div>
            <div class="verticalSection">
              <!-- Simple Collections Section -->
              <div class="inputContainer" style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="checkbox" is="emby-checkbox" id="enable-simple-collections" checked style="margin-right: 10px;" />
                  <span style="font-weight: bold; font-size: 1.1em;">Enable Simple Collections</span>
                </label>
              </div>
              <div id="simple-collections-section">
                <div class="inputContainer">
                  <label class="inputLabel inputLabelUnfocused" for="title-match-pairs">Simple Collections:</label>
                  <div class="help-text">Create collections based on a simple string match. Select the type (Title, Studio, Genre, Actor, or Director), choose media type (All, Movies, or Shows), enter the string to match, and provide a collection name.</div>
                  <div id="title-match-pairs"></div>
                </div>
                
                <button
                  id="add-title-match-button"
                  is="emby-button"
                  type="button"
                  class="raised add-title-match-button"
                >
                  <span>Add Simple Collection</span>
                </button>
              </div>

              <div style="margin: 20px 0 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: rgba(0,0,0,0.03);">
                <h3 style="margin-top: 0; margin-bottom: 10px;">Import/Export Configuration</h3>
                <p style="margin-bottom: 15px; font-size: 0.9em; color: #555;">
                  Export your current configuration to a JSON file or import a configuration from a JSON file.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <button id="export-config-btn" is="emby-button" type="button" class="raised button-submit">
                    <span>Export Config (JSON)</span>
                  </button>
                  <button id="import-overwrite-config-btn" is="emby-button" type="button" class="raised button-submit">
                    <span>Import Config (Overwrite)</span>
                  </button>
                  <input id="import-overwrite-config-input" type="file" accept="application/json" style="display:none;" />
                  <button id="import-add-config-btn" is="emby-button" type="button" class="raised button-submit">
                    <span>Import Config (Merge)</span>
                  </button>
                  <input id="import-add-config-input" type="file" accept="application/json" style="display:none;" />
                </div>
                <div id="import-status" style="margin-top: 10px; font-size: 0.9em;"></div>
              </div>

              <div class="section-divider"></div>
              
              <!-- Advanced Collections Section -->
              <div class="inputContainer" style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="checkbox" is="emby-checkbox" id="enable-advanced-collections" checked style="margin-right: 10px;" />
                  <span style="font-weight: bold; font-size: 1.1em;">Enable Advanced Collections</span>
                </label>
              </div>
              <div id="advanced-collections-section">
                <div class="inputContainer">
                  <label class="inputLabel inputLabelUnfocused" for="expression-collections">Advanced Collections:</label>
                  <div class="help-text">
                    Create collections using complex boolean expressions. Examples:<br>
                    <code>TITLE "Avengers"</code> - Items with "Avengers" in the title<br>
                    <code>FILENAME "REMUX"</code> - Items with "REMUX" in the filename<br>
                    <code>STUDIO "Marvel" AND GENRE "Action"</code> - Marvel action items<br>
                    <code>STUDIO "Marvel" AND (TITLE "Spiderman" OR ACTOR "Robert Downey JR.")</code> - Marvel items with Spiderman in the title or starring Robert Downey Jr.<br>
                    <code>GENRE "Action" AND MOVIE</code> - Action movies only (no TV shows)<br>
                    <code>TITLE "Avengers" OR (GENRE "Action" AND SHOW)</code> - Anything with "Avengers" in the title, plus Action TV shows<br>
                    <br>
                    <strong>New Filter Types:</strong><br>
                    <code>TAG "Family" AND MOVIE</code> - Movies with the "Family" tag<br>
                    <code>PARENTALRATING "PG-13" AND GENRE "Horror"</code> - PG-13 horror content<br>
                    <code>COMMUNITYRATING ">8.5"</code> - Items rated above 8.5<br>
                    <code>CRITICSRATING ">75" AND GENRE "Drama"</code> - Well-reviewed dramas<br>
                    <code>PRODUCTIONLOCATION "Germany" OR PRODUCTIONLOCATION "Austria"</code> - German or Austrian content<br>
                    <code>CUSTOMRATING "PG-13" OR CUSTOMRATING "PG"</code> - Items with specified custom ratings<br>
                    <code>CUSTOMRATING "<=7" AND MOVIE</code> - Movies with custom rating numeric value 7 or below (if numeric values stored)
                    <br>
                    <strong>Year Filters:</strong><br>
                    <code>YEAR "&lt;2000"</code> - Content from before 2000<br>
                    <code>YEAR "&gt;2010"</code> - Content from after 2010<br>
                    <code>YEAR "=1994"</code> - Content from exactly 1994<br>
                    <code>YEAR "&gt;=2000" AND YEAR "&lt;=2010"</code> - Content from the 2000s decade<br>
                    <code>GENRE "Sci-Fi" AND YEAR "&gt;=2000" AND YEAR "&lt;=2010"</code> - Sci-Fi from the 2000s decade
                    <br>
                    <strong>Language Filters:</strong><br>
                    <code>LANG "eng" AND MOVIE</code> - Movies with English audio<br>
                    <code>SUB "eng" AND MOVIE</code> - Movies with English subtitles<br>
                    <code>MOVIE AND (LANG "eng" OR SUB "eng")</code> - Movies with either English audio or subtitles<br>
                    <code>MOVIE AND LANG "fra" AND NOT SUB "eng"</code> - French audio movies without English subtitles
                  </div>
                  <div id="expression-collections"></div>
                </div>
                
                <button
                  id="add-expression-collection-button"
                  is="emby-button"
                  type="button"
                  class="raised add-title-match-button"
                >
                  <span>Add Advanced Collection</span>
                </button>
              </div>

              <div class="section-divider"></div>

              <!-- Auto-Discovery Collections Section -->
              <div class="inputContainer" style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="checkbox" is="emby-checkbox" id="enable-auto-discovery" style="margin-right: 10px;" />
                  <span style="font-weight: bold; font-size: 1.1em;">Enable Auto-Discovery Collections</span>
                </label>
                <div class="help-text">Automatically create collections based on your library content. No manual configuration needed!</div>
              </div>
              <div id="auto-discovery-section" style="display: none; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: rgba(0,0,0,0.03); margin-bottom: 20px;">
                
                <!-- Movie Series Detection -->
                <div style="margin-bottom: 20px; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 4px;">
                  <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                    <input type="checkbox" is="emby-checkbox" id="detect-movie-series" checked style="margin-right: 10px;" />
                    <span style="font-weight: bold;">Detect Movie Series/Franchises</span>
                  </label>
                  <div class="help-text" style="margin-bottom: 10px;">Automatically detects films with similar titles like "John Wick 1-4", "Star Wars Episode I-IX", etc.</div>
                  
                  <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                      <label style="font-size: 0.9em;">Minimum movies in series:</label>
                      <select is="emby-select" id="min-movies-in-series" style="width: 80px; margin-left: 5px;">
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 0.9em;">Naming pattern:</label>
                      <select is="emby-select" id="movie-series-naming" style="width: 180px; margin-left: 5px;">
                        <option value="{Title} Collection" selected>{Title} Collection</option>
                        <option value="{Title} Saga">{Title} Saga</option>
                        <option value="{Title} Movies">{Title} Movies</option>
                        <option value="{Title} Series">{Title} Series</option>
                      </select>
                    </div>
                  </div>
                  <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" is="emby-checkbox" id="include-first-without-number" checked style="margin-right: 8px;" />
                      <span style="font-size: 0.9em;">Include first movie without number (e.g., "John Wick" + "John Wick 2")</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; margin-top: 5px;">
                      <input type="checkbox" is="emby-checkbox" id="include-spinoffs" style="margin-right: 8px;" />
                      <span style="font-size: 0.9em;">Include spin-offs (matches "A {Title} Story" pattern)</span>
                    </label>
                  </div>
                </div>

                <!-- Genre Collections -->
                <div style="margin-bottom: 20px; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 4px;">
                  <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                    <input type="checkbox" is="emby-checkbox" id="create-genre-collections" style="margin-right: 10px;" />
                    <span style="font-weight: bold;">Create Genre Collections</span>
                  </label>
                  <div class="help-text" style="margin-bottom: 10px;">Automatically creates collections for each genre (Action, Comedy, Drama, etc.)</div>
                  
                  <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                      <label style="font-size: 0.9em;">Minimum items per genre:</label>
                      <select is="emby-select" id="min-items-per-genre" style="width: 80px; margin-left: 5px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 0.9em;">Naming pattern:</label>
                      <select is="emby-select" id="genre-naming" style="width: 180px; margin-left: 5px;">
                        <option value="{Genre} Movies" selected>{Genre} Movies</option>
                        <option value="{Genre} Collection">{Genre} Collection</option>
                        <option value="{Genre}">{Genre}</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Studio Collections -->
                <div style="margin-bottom: 20px; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 4px;">
                  <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                    <input type="checkbox" is="emby-checkbox" id="create-studio-collections" style="margin-right: 10px;" />
                    <span style="font-weight: bold;">Create Studio Collections</span>
                  </label>
                  <div class="help-text" style="margin-bottom: 10px;">Automatically creates collections for each studio (Marvel, Pixar, Warner Bros, etc.)</div>
                  
                  <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                      <label style="font-size: 0.9em;">Minimum items per studio:</label>
                      <select is="emby-select" id="min-items-per-studio" style="width: 80px; margin-left: 5px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 0.9em;">Naming pattern:</label>
                      <select is="emby-select" id="studio-naming" style="width: 180px; margin-left: 5px;">
                        <option value="{Studio}" selected>{Studio}</option>
                        <option value="{Studio} Productions">{Studio} Productions</option>
                        <option value="{Studio} Collection">{Studio} Collection</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Decade Collections -->
                <div style="margin-bottom: 20px; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 4px;">
                  <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                    <input type="checkbox" is="emby-checkbox" id="create-decade-collections" style="margin-right: 10px;" />
                    <span style="font-weight: bold;">Create Decade Collections</span>
                  </label>
                  <div class="help-text" style="margin-bottom: 10px;">Automatically creates collections by decade (1990s, 2000s, 2010s, etc.)</div>
                  
                  <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                      <label style="font-size: 0.9em;">Minimum items per decade:</label>
                      <select is="emby-select" id="min-items-per-decade" style="width: 80px; margin-left: 5px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 0.9em;">Naming pattern:</label>
                      <select is="emby-select" id="decade-naming" style="width: 180px; margin-left: 5px;">
                        <option value="{Decade}s Movies" selected>{Decade}s Movies</option>
                        <option value="{Decade}s Collection">{Decade}s Collection</option>
                        <option value="{Decade}s">{Decade}s</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Additional Options -->
                <div style="padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 4px;">
                  <h4 style="margin-top: 0; margin-bottom: 10px;">Additional Options</h4>
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.9em;">Prefix for auto-generated collections:</label>
                    <input type="text" is="emby-input" id="auto-discovery-prefix" placeholder="e.g., [Auto] " style="width: 150px; margin-left: 5px;" />
                  </div>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" is="emby-checkbox" id="skip-existing-manual" checked style="margin-right: 8px;" />
                    <span style="font-size: 0.9em;">Skip if manual collection with same name exists</span>
                  </label>
                </div>
              </div>
              
              <br />
              <button
                id="saveConfiguration"
                is="emby-button"
                class="raised button-submit block"
              >
                <span>Save</span>
              </button>
            </div>
            <br />
            <button
              is="emby-button"
              type="button"
              class="raised block"
              id="sync-Auto-collections"
              onclick="execute()"
            >
              <span>Sync Auto Collections</span>
            </button>
          </form>
        </div>
      </div>      <script type="text/javascript" defer>
        // For expression-based collections
        function createExpressionCollectionElement(expression = '', collectionName = '', caseSensitive = false) {
          const container = document.createElement('div');
          container.className = 'expression-container';
          container.style.display = 'flex';
          container.style.flexWrap = 'wrap';
          container.style.alignItems = 'center';
          container.style.padding = '8px';
          container.style.marginBottom = '10px';
          container.style.borderRadius = '4px';
          container.style.backgroundColor = 'rgba(0,0,0,0.05)';
          
          // Collection Name Input
          const collectionNameContainer = document.createElement('div');
          collectionNameContainer.style.flex = '1 1 200px';
          collectionNameContainer.style.marginRight = '10px';
          
          const collectionNameInput = document.createElement('input');
          collectionNameInput.is = 'emby-input';
          collectionNameInput.type = 'text';
          collectionNameInput.className = 'collection-name-input';
          collectionNameInput.style.width = '100%';
          collectionNameInput.placeholder = 'Collection Name';
          collectionNameInput.value = collectionName;
          
          collectionNameContainer.appendChild(collectionNameInput);
          
          // Expression Input
          const expressionContainer = document.createElement('div');
          expressionContainer.style.flex = '1 1 300px';
          expressionContainer.style.marginRight = '10px';
          
          const expressionInput = document.createElement('input');
          expressionInput.is = 'emby-input';
          expressionInput.type = 'text';
          expressionInput.className = 'expression-input';
          expressionInput.style.width = '100%';
          expressionInput.placeholder = 'TITLE "Avengers" OR (STUDIO "Marvel" AND GENRE "Action")';
          expressionInput.value = expression;
          
          expressionContainer.appendChild(expressionInput);
          
          // Case-sensitive checkbox
          const caseCheckContainer = document.createElement('div');
          caseCheckContainer.className = 'case-sensitive-check';
          caseCheckContainer.style.flex = '0 0 auto';
          caseCheckContainer.style.display = 'flex';
          caseCheckContainer.style.alignItems = 'center';
          caseCheckContainer.style.marginRight = '10px';
          
          const caseCheckboxWrapper = document.createElement('div');
          caseCheckboxWrapper.style.marginRight = '5px';
          
          const caseCheckbox = document.createElement('input');
          caseCheckbox.is = 'emby-checkbox';
          caseCheckbox.type = 'checkbox';
          caseCheckbox.className = 'case-sensitive-checkbox';
          caseCheckbox.checked = caseSensitive;
          
          const caseLabel = document.createElement('label');
          caseLabel.className = 'case-label';
          caseLabel.textContent = 'Case Sensitive';
          caseLabel.style.marginLeft = '5px';
          caseLabel.style.fontSize = '14px';
          
          caseCheckboxWrapper.appendChild(caseCheckbox);
          caseCheckContainer.appendChild(caseCheckboxWrapper);
          caseCheckContainer.appendChild(caseLabel);
          
          // Remove button
          const removeButton = document.createElement('button');
          removeButton.is = 'emby-button';
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.innerHTML = '<span>✕</span>';
          removeButton.style.flex = '0 0 auto';
          removeButton.style.minWidth = '32px';
          removeButton.style.height = '32px';
          removeButton.style.padding = '0';
          removeButton.style.borderRadius = '50%';
          removeButton.onclick = function() {
            container.remove();
          };
          
          // Add all components
          container.appendChild(collectionNameContainer);
          container.appendChild(expressionContainer);
          container.appendChild(caseCheckContainer);
          container.appendChild(removeButton);
          
          return container;
        }
        
        function createTitleMatchPairElement(titleMatch = '', collectionName = '', caseSensitive = false, matchType = 0, mediaType = 0) {
          const container = document.createElement('div');
          container.className = 'title-match-container';
          container.style.display = 'flex';
          container.style.flexWrap = 'wrap';
          container.style.alignItems = 'center';
          container.style.padding = '8px';
          container.style.marginBottom = '10px';
          container.style.borderRadius = '4px';
          container.style.backgroundColor = 'rgba(0,0,0,0.05)';
            
          // Create match type dropdown
          const matchTypeContainer = document.createElement('div');
          matchTypeContainer.className = 'match-type-container';
          matchTypeContainer.style.marginRight = '10px';
          matchTypeContainer.style.minWidth = '100px';
          matchTypeContainer.style.flex = '0 0 100px';
          
          const matchTypeSelect = document.createElement('select');
          matchTypeSelect.is = 'emby-select';
          matchTypeSelect.className = 'match-type-select';
            
          // Add match type options
          const options = [
            { value: '0', text: 'Title' },
            { value: '1', text: 'Genre' },
            { value: '2', text: 'Studio' },
            { value: '3', text: 'Actor' },
            { value: '4', text: 'Director' }
          ];
          
          options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.text = opt.text;
            matchTypeSelect.appendChild(option);
          });
            
          // Set the selected option based on matchType parameter
          if (matchType !== undefined) {
            matchTypeSelect.value = matchType.toString();
          }
          
          matchTypeContainer.appendChild(matchTypeSelect);
          
          // Create media type dropdown
          const mediaTypeContainer = document.createElement('div');
          mediaTypeContainer.className = 'media-type-container';
          mediaTypeContainer.style.marginRight = '10px';
          mediaTypeContainer.style.minWidth = '100px';
          mediaTypeContainer.style.flex = '0 0 100px';
          
          const mediaTypeSelect = document.createElement('select');
          mediaTypeSelect.is = 'emby-select';
          mediaTypeSelect.className = 'media-type-select';
          
          // Add media type options
          const mediaOptions = [
            { value: '0', text: 'All' },
            { value: '1', text: 'Movies' },
            { value: '2', text: 'Shows' }
          ];
          
          mediaOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.text = opt.text;
            mediaTypeSelect.appendChild(option);
          });
          
          // Set the selected option based on mediaType parameter
          if (mediaType !== undefined) {
            mediaTypeSelect.value = mediaType.toString();
          }
          
          mediaTypeContainer.appendChild(mediaTypeSelect);
          
          // This ensures the Emby select components are properly initialized
          setTimeout(() => {
            if (matchTypeSelect.embyInit) {
              matchTypeSelect.embyInit();
            }
            if (mediaTypeSelect.embyInit) {
              mediaTypeSelect.embyInit();
            } else if (window.EmbyWebComponents && window.EmbyWebComponents.autoFocus) {
              window.EmbyWebComponents.autoFocus(matchTypeSelect.parentNode);
              window.EmbyWebComponents.autoFocus(mediaTypeSelect.parentNode);
            }
          }, 0);
            
          // Create a dynamic update for the placeholder text based on the selected match type
          const updatePlaceholder = (select) => {
            const matchType = parseInt(select.value, 10);
            const input = container.querySelector('.title-match-input');
            if (input) {
              switch(matchType) {
                case 1: // Genre
                  input.placeholder = 'Genre to match (e.g. Action, Comedy)';
                  break;
                case 2: // Studio
                  input.placeholder = 'Studio to match (e.g. Marvel, Paramount)';
                  break;
                case 3: // Actor
                  input.placeholder = 'Actor name to match (e.g. Tom Hanks, Scarlett)';
                  break;
                case 4: // Director
                  input.placeholder = 'Director name to match (e.g. Spielberg, Nolan)';
                  break;
                default: // Title
                  input.placeholder = 'Text in title to match';
              }
            }
          };
          
          // Add change event to update placeholder when match type changes
          matchTypeSelect.addEventListener('change', () => {
            updatePlaceholder(matchTypeSelect);
          });
            
          const titleMatchContainer = document.createElement('div');
          titleMatchContainer.style.flex = '1 1 200px';
          titleMatchContainer.style.marginRight = '10px';
          
          const titleMatchInput = document.createElement('input');
          titleMatchInput.is = 'emby-input';
          titleMatchInput.type = 'text';
          titleMatchInput.className = 'title-match-input';
          titleMatchInput.style.width = '100%';
          titleMatchInput.placeholder = 'Match String';
          titleMatchInput.value = titleMatch;
          
          titleMatchContainer.appendChild(titleMatchInput);
          
          // Set initial placeholder based on match type
          setTimeout(() => updatePlaceholder(matchTypeSelect), 0);
            
          const collectionNameContainer = document.createElement('div');
          collectionNameContainer.style.flex = '1 1 200px';
          collectionNameContainer.style.marginRight = '10px';
          
          const collectionNameInput = document.createElement('input');
          collectionNameInput.is = 'emby-input';
          collectionNameInput.type = 'text';
          collectionNameInput.className = 'collection-name-input';
          collectionNameInput.style.width = '100%';
          collectionNameInput.placeholder = 'Collection Name';
          collectionNameInput.value = collectionName;
          
          collectionNameContainer.appendChild(collectionNameInput);
            
          // Create case-sensitive checkbox
          const caseCheckContainer = document.createElement('div');
          caseCheckContainer.className = 'case-sensitive-check';
          caseCheckContainer.style.flex = '0 0 auto';
          caseCheckContainer.style.display = 'flex';
          caseCheckContainer.style.alignItems = 'center';
          caseCheckContainer.style.marginRight = '10px';
          
          const caseCheckboxWrapper = document.createElement('div');
          caseCheckboxWrapper.style.marginRight = '5px';
          
          const caseCheckbox = document.createElement('input');
          caseCheckbox.is = 'emby-checkbox';
          caseCheckbox.type = 'checkbox';
          caseCheckbox.className = 'case-sensitive-checkbox';
          caseCheckbox.checked = caseSensitive;
          
          const caseLabel = document.createElement('label');
          caseLabel.className = 'case-label';
          caseLabel.textContent = 'Case Sensitive';
          caseLabel.style.marginLeft = '5px';
          caseLabel.style.fontSize = '14px';
          
          caseCheckboxWrapper.appendChild(caseCheckbox);
          caseCheckContainer.appendChild(caseCheckboxWrapper);
          caseCheckContainer.appendChild(caseLabel);
            
          const removeButton = document.createElement('button');
          removeButton.is = 'emby-button';
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.innerHTML = '<span>✕</span>';
          removeButton.style.flex = '0 0 auto';
          removeButton.style.minWidth = '32px';
          removeButton.style.height = '32px';
          removeButton.style.padding = '0';
          removeButton.style.borderRadius = '50%';
          removeButton.onclick = function() {
            container.remove();
          };
          
          // Add all components to container in order
          container.appendChild(matchTypeContainer);
          container.appendChild(mediaTypeContainer); // Add media type dropdown
          container.appendChild(titleMatchContainer);
          container.appendChild(collectionNameContainer);
          container.appendChild(caseCheckContainer);
          container.appendChild(removeButton);
          
          return container;
        }
          function loadConfig() {
          window.ApiClient.getPluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb"
          ) // Plugin Id
            .then(function (config) {
              // Load simple collections
              const titleMatchPairsContainer = document.querySelector("#title-match-pairs");
              titleMatchPairsContainer.innerHTML = '';
                
              // Check if we have the TitleMatchPairs property
              if (config.TitleMatchPairs && config.TitleMatchPairs.length > 0) {
                config.TitleMatchPairs.forEach(pair => {                  
                  // Convert MatchType enum string to numeric value for the dropdown
                  let matchTypeValue = 0; // Default to Title
                  if (pair.MatchType !== undefined) {
                    switch (pair.MatchType) {
                      case "Title":
                        matchTypeValue = 0;
                        break;
                      case "Genre":
                        matchTypeValue = 1;
                        break;
                      case "Studio":
                        matchTypeValue = 2;
                        break;
                      case "Actor":
                        matchTypeValue = 3;
                        break;
                      case "Director":
                        matchTypeValue = 4;
                        break;
                      // Fallback for numeric values (backward compatibility)
                      default:
                        if (typeof pair.MatchType === 'number') {
                          matchTypeValue = pair.MatchType;
                        }
                    }
                  }

                  // Convert MediaType enum to numeric value for the dropdown
                  let mediaTypeValue = 0; // Default to All
                  if (pair.MediaType !== undefined) {
                    switch (pair.MediaType) {
                      case "All":
                        mediaTypeValue = 0;
                        break;
                      case "Movies":
                        mediaTypeValue = 1;
                        break;
                      case "Series":
                        mediaTypeValue = 2;
                        break;
                      // Fallback for numeric values (backward compatibility)
                      default:
                        if (typeof pair.MediaType === 'number') {
                          mediaTypeValue = pair.MediaType;
                        }
                    }
                  }
                  
                  const element = createTitleMatchPairElement(
                    pair.TitleMatch, 
                    pair.CollectionName, 
                    pair.CaseSensitive, 
                    matchTypeValue,
                    mediaTypeValue
                  );
                  titleMatchPairsContainer.appendChild(element);
                });
              } 
              else {
                // If no configuration exists yet, add one empty row
                const element = createTitleMatchPairElement();
                titleMatchPairsContainer.appendChild(element);
              }
              

              // Load expression collections
              const expressionCollectionsContainer = document.querySelector("#expression-collections");
              expressionCollectionsContainer.innerHTML = '';
              

              // Check if we have the ExpressionCollections property
              if (config.ExpressionCollections && config.ExpressionCollections.length > 0) {
                config.ExpressionCollections.forEach(collection => {
                  const element = createExpressionCollectionElement(
                    collection.Expression,
                    collection.CollectionName,
                    collection.CaseSensitive
                  );
                  expressionCollectionsContainer.appendChild(element);
                });
              } else {
                // If no expression collections exist yet, add one empty row
                const element = createExpressionCollectionElement();
                expressionCollectionsContainer.appendChild(element);
              }

              // Load section toggles
              document.getElementById('enable-simple-collections').checked = config.EnableSimpleCollections !== false;
              document.getElementById('enable-advanced-collections').checked = config.EnableAdvancedCollections !== false;
              document.getElementById('enable-auto-discovery').checked = config.EnableAutoDiscovery === true;

              // Update section visibility
              updateSectionVisibility();

              // Load Auto-Discovery settings
              document.getElementById('detect-movie-series').checked = config.DetectMovieSeries !== false;
              document.getElementById('min-movies-in-series').value = config.MinMoviesInSeries || 2;
              document.getElementById('movie-series-naming').value = config.MovieSeriesNamingPattern || '{Title} Collection';
              document.getElementById('include-first-without-number').checked = config.IncludeFirstMovieWithoutNumber !== false;
              document.getElementById('include-spinoffs').checked = config.IncludeSpinoffs === true;

              document.getElementById('create-genre-collections').checked = config.CreateGenreCollections === true;
              document.getElementById('min-items-per-genre').value = config.MinItemsPerGenre || 3;
              document.getElementById('genre-naming').value = config.GenreNamingPattern || '{Genre} Movies';

              document.getElementById('create-studio-collections').checked = config.CreateStudioCollections === true;
              document.getElementById('min-items-per-studio').value = config.MinItemsPerStudio || 5;
              document.getElementById('studio-naming').value = config.StudioNamingPattern || '{Studio}';

              document.getElementById('create-decade-collections').checked = config.CreateDecadeCollections === true;
              document.getElementById('min-items-per-decade').value = config.MinItemsPerDecade || 3;
              document.getElementById('decade-naming').value = config.DecadeNamingPattern || '{Decade}s Movies';

              document.getElementById('auto-discovery-prefix').value = config.AutoDiscoveryPrefix || '';
              document.getElementById('skip-existing-manual').checked = config.SkipExistingManualCollections !== false;
            })
            .catch(function (error) {
              console.error(error);
              // Add empty rows if there's an error
              const titleElement = createTitleMatchPairElement();
              document.querySelector("#title-match-pairs").appendChild(titleElement);
              
              const expressionElement = createExpressionCollectionElement();
              document.querySelector("#expression-collections").appendChild(expressionElement);
            });
        }        function saveConfig() {
          // Validate expressions before saving
          let allExpressionContainers = document.querySelectorAll('.expression-container');
          let hasErrors = false;
          
          allExpressionContainers.forEach(container => {
            const expressionInput = container.querySelector('.expression-input');
            if (expressionInput && expressionInput.value.trim()) {
              const result = validateExpression(expressionInput.value);
              if (!result.valid) {
                hasErrors = true;
                alert(`Expression error: ${result.error} in collection "${container.querySelector('.collection-name-input').value || 'Unnamed'}"`);
              }
            }
          });
          
          if (hasErrors) {
            return; // Don't save if there are validation errors
          }
          
          // Process simple collections
          const titleMatchContainers = document.querySelectorAll('.title-match-container');
          const titleMatchPairs = [];
            
          titleMatchContainers.forEach(container => {
            // Handle our new nested structure
            const titleMatchInput = container.querySelector('.title-match-input');
            const collectionNameInput = container.querySelector('.collection-name-input');
            const caseSensitiveCheckbox = container.querySelector('.case-sensitive-checkbox');
            const matchTypeSelect = container.querySelector('.match-type-select');
            const mediaTypeSelect = container.querySelector('.media-type-select');
              if (titleMatchInput.value.trim()) {
              const titleMatch = titleMatchInput.value.trim();
              const collectionName = collectionNameInput.value.trim();
              const caseSensitive = caseSensitiveCheckbox.checked;
              // Convert numeric value to enum string representation
              const matchTypeValue = parseInt(matchTypeSelect.value, 10);
              let matchTypeString;
              switch (matchTypeValue) {
                case 0:
                  matchTypeString = "Title";
                  break;
                case 1:
                  matchTypeString = "Genre";
                  break;
                case 2:
                  matchTypeString = "Studio";
                  break;
                case 3:
                  matchTypeString = "Actor";
                  break;
                case 4:
                  matchTypeString = "Director";
                  break;
                default:
                  matchTypeString = "Title";
              }
              

              // Convert numeric value to enum string representation for media type
              const mediaTypeValue = parseInt(mediaTypeSelect.value, 10);
              let mediaTypeString;
              switch (mediaTypeValue) {
                case 0:
                  mediaTypeString = "All";
                  break;
                case 1:
                  mediaTypeString = "Movies";
                  break;
                case 2:
                  mediaTypeString = "Series";
                  break;
                default:
                  mediaTypeString = "All";
              }
              
              titleMatchPairs.push({
                TitleMatch: titleMatch,
                CollectionName: collectionName || null, // Use null if collection name is empty
                CaseSensitive: caseSensitive,
                MatchType: matchTypeString,
                MediaType: mediaTypeString
              });
            }
          });
            // Process expression collections
          const expressionCollections = [];
          
          allExpressionContainers.forEach(container => {
            const expressionInput = container.querySelector('.expression-input');
            const collectionNameInput = container.querySelector('.collection-name-input');
            const caseSensitiveCheckbox = container.querySelector('.case-sensitive-checkbox');
            
            if (expressionInput.value.trim()) {
              expressionCollections.push({
                Expression: expressionInput.value.trim(),
                CollectionName: collectionNameInput.value.trim() || "Expression Collection",
                CaseSensitive: caseSensitiveCheckbox.checked
              });
            }
          });
          
          const config = {
            TitleMatchPairs: titleMatchPairs,
            ExpressionCollections: expressionCollections,
            IsInitialized: true, // Mark as initialized to prevent defaults from being re-added
            // Keep these empty for backward compatibility
            TagTitlePairs: [],
            Tags: [],
            
            // Section toggles
            EnableSimpleCollections: document.getElementById('enable-simple-collections').checked,
            EnableAdvancedCollections: document.getElementById('enable-advanced-collections').checked,
            EnableAutoDiscovery: document.getElementById('enable-auto-discovery').checked,
            
            // Auto-Discovery: Movie Series
            DetectMovieSeries: document.getElementById('detect-movie-series').checked,
            MinMoviesInSeries: parseInt(document.getElementById('min-movies-in-series').value, 10) || 2,
            MovieSeriesNamingPattern: document.getElementById('movie-series-naming').value || '{Title} Collection',
            IncludeFirstMovieWithoutNumber: document.getElementById('include-first-without-number').checked,
            IncludeSpinoffs: document.getElementById('include-spinoffs').checked,
            
            // Auto-Discovery: Genre
            CreateGenreCollections: document.getElementById('create-genre-collections').checked,
            MinItemsPerGenre: parseInt(document.getElementById('min-items-per-genre').value, 10) || 3,
            GenreNamingPattern: document.getElementById('genre-naming').value || '{Genre} Movies',
            
            // Auto-Discovery: Studio
            CreateStudioCollections: document.getElementById('create-studio-collections').checked,
            MinItemsPerStudio: parseInt(document.getElementById('min-items-per-studio').value, 10) || 5,
            StudioNamingPattern: document.getElementById('studio-naming').value || '{Studio}',
            
            // Auto-Discovery: Decade
            CreateDecadeCollections: document.getElementById('create-decade-collections').checked,
            MinItemsPerDecade: parseInt(document.getElementById('min-items-per-decade').value, 10) || 3,
            DecadeNamingPattern: document.getElementById('decade-naming').value || '{Decade}s Movies',
            
            // Auto-Discovery: Additional Options
            AutoDiscoveryPrefix: document.getElementById('auto-discovery-prefix').value || '',
            SkipExistingManualCollections: document.getElementById('skip-existing-manual').checked
          };
          
          window.ApiClient.updatePluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb",
            config
          )
            .then(() => alert("Update success"))
            .catch(function (error) {
              console.error(error);
              alert("Error saving configuration");
            });
        }
        
        function execute() {
          var request = {
            url: ApiClient.getUrl("/AutoCollections/AutoCollections"),
            type: "POST"
          };

          ApiClient.fetch(request)
            .then(function () {
              Dashboard.alert("Executing Auto Collections...");
            })
            .catch(function () {
              Dashboard.alert({
                message: "Unexpected error occurred!"
              });
            });
        }

        // Function to update section visibility based on toggles
        function updateSectionVisibility() {
          const simpleEnabled = document.getElementById('enable-simple-collections').checked;
          const advancedEnabled = document.getElementById('enable-advanced-collections').checked;
          const autoDiscoveryEnabled = document.getElementById('enable-auto-discovery').checked;

          document.getElementById('simple-collections-section').style.display = simpleEnabled ? 'block' : 'none';
          document.getElementById('advanced-collections-section').style.display = advancedEnabled ? 'block' : 'none';
          document.getElementById('auto-discovery-section').style.display = autoDiscoveryEnabled ? 'block' : 'none';
        }

        // Initialize the page
        loadConfig();
        
        // Add event listeners
        document.querySelector("#saveConfiguration").addEventListener("click", saveConfig);
        document.querySelector("#add-title-match-button").addEventListener("click", function() {
          const element = createTitleMatchPairElement();
          document.querySelector("#title-match-pairs").appendChild(element);
        });

        // Section toggle event listeners
        document.getElementById('enable-simple-collections').addEventListener('change', updateSectionVisibility);
        document.getElementById('enable-advanced-collections').addEventListener('change', updateSectionVisibility);
        document.getElementById('enable-auto-discovery').addEventListener('change', updateSectionVisibility);

        document.querySelector("#add-expression-collection-button").addEventListener("click", function() {
          const element = createExpressionCollectionElement();
          document.querySelector("#expression-collections").appendChild(element);
          // Setup validation for the new expression input
          setupExpressionValidation();
        });
        
        // Setup validation for initial expression inputs
        setupExpressionValidation();
        
        // Function to validate the expression syntax (simplified version)
        function validateExpression(expressionText) {
          if (!expressionText || expressionText.trim() === '') {
            return { valid: false, error: "Expression cannot be empty" };
          }
          
          // Simple validation - make sure quotes are properly paired
          const quoteCount = (expressionText.match(/"/g) || []).length;
          if (quoteCount % 2 !== 0) {
            return { valid: false, error: "Mismatched quotes in expression" };
          }
          
          // Check for balanced parentheses
          const openParens = (expressionText.match(/\(/g) || []).length;
          const closeParens = (expressionText.match(/\)/g) || []).length;
          if (openParens !== closeParens) {
            return { valid: false, error: "Mismatched parentheses in expression" };
          }
            // Check for at least one criteria type
            const criteriaTypes = [
            "TITLE", "GENRE", "STUDIO", "ACTOR", "DIRECTOR", "MOVIE", "SHOW",
            "TAG", "PARENTALRATING", "RATING", "COMMUNITYRATING", "CRITICSRATING",
            "PRODUCTIONLOCATION", "LOCATION", "COUNTRY", "LANG", "SUB", "YEAR", "CUSTOMRATING", "CUSTOM", "FILENAME"
          ];
          let hasCriteria = false;
          
          for (const type of criteriaTypes) {
            if (expressionText.toUpperCase().includes(type)) {
              hasCriteria = true;
              break;
            }
          }            if (!hasCriteria) {
            return { 
              valid: false, 
              error: "Expression must contain at least one criteria (TITLE, GENRE, STUDIO, ACTOR, DIRECTOR, MOVIE, SHOW, TAG, PARENTALRATING, COMMUNITYRATING, CRITICSRATING, PRODUCTIONLOCATION, LANG, SUB, YEAR, FILENAME)" 
            // Note: validation error message not updated to include CUSTOMRATING for legacy backward compatibility UI; actual parser supports it
            };
          }
          
          return { valid: true };
        }
        
        // Add real-time validation to expression inputs
        function setupExpressionValidation() {
          const expressionContainers = document.querySelectorAll('.expression-container');
          
          expressionContainers.forEach(container => {
            const expressionInput = container.querySelector('.expression-input');
            if (expressionInput) {
              expressionInput.addEventListener('blur', function() {
                const result = validateExpression(expressionInput.value);
                
                // Remove any existing error message
                const existingError = container.querySelector('.expression-error');
                if (existingError) {
                  existingError.remove();
                }
                
                // Add error message if validation failed
                if (!result.valid) {
                  const errorElement = document.createElement('div');
                  errorElement.className = 'expression-error';
                  errorElement.style.color = 'red';
                  errorElement.style.fontSize = '0.9em';
                  errorElement.style.marginTop = '5px';
                  errorElement.textContent = result.error;
                  

                  // Insert after the expression input
                  expressionInput.parentNode.appendChild(errorElement);
                }
              });
            }
          });
        }
        
        // Initialize expression validation on load
        setupExpressionValidation();

        // Export config logic
        document.getElementById('export-config-btn').addEventListener('click', function() {
          fetch(ApiClient.getUrl('AutoCollections/ExportConfiguration'), { // Use ApiClient.getUrl and add auth
            method: 'GET',
            headers: { 
              'Accept': 'application/json',
              'X-MediaBrowser-Token': ApiClient.accessToken()
            }
          })
          .then(response => {
            if (!response.ok) throw new Error('Failed to export configuration: ' + response.statusText);
            return response.blob();
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'auto-collections-config.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            document.getElementById('import-status').textContent = 'Configuration exported successfully.';
            document.getElementById('import-status').style.color = "#4F8A10";
          })
          .catch(err => { 
            document.getElementById('import-status').textContent = 'Export failed: ' + err.message;
            document.getElementById('import-status').style.color = "#D8000C";
            console.error(err); 
          });
        });

        // Import overwrite config logic
        document.getElementById('import-overwrite-config-btn').addEventListener('click', function() {
          document.getElementById('import-overwrite-config-input').click();
        });

        document.getElementById('import-overwrite-config-input').addEventListener('change', function(event) {
          handleImportFile(event, 'AutoCollections/ImportConfiguration', 'overwrite');
        });

        // Import add/merge config logic
        document.getElementById('import-add-config-btn').addEventListener('click', function() {
          document.getElementById('import-add-config-input').click();
        });

        document.getElementById('import-add-config-input').addEventListener('change', function(event) {
          handleImportFile(event, 'AutoCollections/AddConfiguration', 'merge');
        });

        function handleImportFile(event, endpoint, mode) {
          const file = event.target.files[0];
          const statusEl = document.getElementById('import-status');
          if (!file) return;

          if (!file.name.toLowerCase().endsWith('.json') && file.type !== 'application/json') {
            statusEl.textContent = 'Please select a JSON file.';
            statusEl.style.color = "#D8000C";
            event.target.value = null; // Reset file input
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            let jsonContent = e.target.result;
            try {
              // Simple comment removal for // style comments
              jsonContent = jsonContent.replace(/\/\/.*$/gm, '');
              JSON.parse(jsonContent); // Validate JSON

              statusEl.textContent = `Importing and ${mode === 'overwrite' ? 'overwriting' : 'merging'} configuration...`;
              statusEl.style.color = "#00529B";

              fetch(ApiClient.getUrl(endpoint), { // Pass endpoint directly to ApiClient.getUrl
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'X-MediaBrowser-Token': ApiClient.accessToken()
                },
                body: jsonContent
              })
              .then(response => {
                if (response.status === 204) { // No Content is a success
                  return { ok: true, message: `Configuration ${mode}d successfully.` };
                }
                // Check if the response is not OK and not JSON, then throw an error with text content
                if (!response.ok && !response.headers.get('content-type')?.includes('application/json')) {
                  return response.text().then(text => { throw new Error(`Server returned ${response.status}: ${text || response.statusText}`); });
                }
                // Otherwise, try to parse as JSON, or fall back to text if JSON parsing fails
                return response.json().catch(() => response.text().then(text => ({ message: text, ok: response.ok, status: response.status })));
              })
              .then(data => {
                // Check for various success conditions
                if (data.ok || (data.status && data.status >= 200 && data.status < 300) || data.Success) {
                  statusEl.textContent = `Configuration ${mode}d successfully. Reloading page...`;
                  statusEl.style.color = "#4F8A10";
                  setTimeout(() => window.location.reload(), 1500);
                } else {
                  const errorMessage = data.message || data.Message || data.error || data.Error || 'Unknown error during import.';
                  statusEl.textContent = `Import (${mode}) failed: ${errorMessage}`;
                  statusEl.style.color = "#D8000C";
                }
              })
              .catch(err => {
                console.error(err);
                statusEl.textContent = `Import (${mode}) failed: ${err.message}`;
                statusEl.style.color = "#D8000C";
              });
            } catch (err) {
              statusEl.textContent = 'Invalid JSON file: ' + err.message;
              statusEl.style.color = "#D8000C";
            } finally {
                event.target.value = null; // Reset file input
            }
          };
          reader.readAsText(file);
        }
      </script>
    </div>
  </body>
</html>